<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KMC后勤物资 (Smart Sync v3.3 Admin Update)</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div id="login-screen" style="position:fixed; inset:0; background: var(--bg); z-index:4000; display:flex; justify-content:center; align-items:center;">
        <div style="background: var(--panel); padding:30px; width:300px; border-radius:12px; text-align:center;">
            <div style="font-size:36px; margin-bottom:12px;"><i class="fas fa-cubes" style="color:var(--text)"></i></div>
            <h2 style="margin:0 0 5px 0; color:var(--text)">KMC后勤物资</h2>
            <p style="font-size:12px; color:var(--text-muted); margin-bottom:24px;">KMC Logistics (Smart Sync V3.3)</p>
            <div style="text-align:left; margin-bottom:15px;">
                <label class="label">Role (身份)</label>
                <select id="login-role" class="select" onchange="app.roleSwitch(this.value)">
                    <option value="keeper">Warehouse Keeper (库管员)</option>
                    <option value="admin">Admin (管理员)</option>
                </select>
            </div>
            <div id="pass-area" style="text-align:left; margin-bottom:24px;">
                <label class="label">Password (密码)</label>
                <input type="password" id="login-pass" class="input" autocomplete="off">
            </div>
            <button class="btn btn-primary" onclick="app.login()">Enter System (进入系统)</button>
        </div>
    </div>

    <header class="header">
        <div class="brand" onclick="app.triggerAdmin()" title="Tap 7 times for God Mode"><i class="fas fa-cube"></i> KMC <span id="user-badge" style="font-size:10px; background:#1f6feb; color:white; padding:2px 8px; border-radius:4px; font-weight:700;"></span></div>
        <div class="header-actions">
            <div class="icon-btn sync" id="cloud-btn" onclick="app.smartSync()" title="Smart Sync (智能同步)"><i class="fas fa-cloud"></i></div>
            <div class="icon-btn exit" onclick="location.reload()"><i class="fas fa-sign-out-alt"></i></div>
        </div>
    </header>

    <div class="action-grid-wrapper">
        <div class="action-grid">
            <div class="action-card" onclick="app.togglePanel('in')" id="card-in">
                <i class="fas fa-arrow-circle-down" style="color:var(--in)"></i>
                <span>Inbound<br>(入库)</span>
            </div>
            <div class="action-card" onclick="app.togglePanel('out')" id="card-out">
                <i class="fas fa-arrow-circle-up" style="color:var(--out)"></i>
                <span>Outbound<br>(出库)</span>
            </div>
            <div class="action-card" onclick="app.openReportCenter()">
                <i class="fas fa-chart-pie" style="color:#a371f7"></i>
                <span>Reports<br>(报表)</span>
            </div>
            <div class="action-card" onclick="app.togglePanel('rules')" id="card-rules" style="display:none;">
                <i class="fas fa-tasks" style="color:#e2e8f0"></i>
                <span>Rules<br>(规则)</span>
            </div>
        </div>
    </div>

    <div class="main-scroll">
        <div id="panel-in" class="panel-box">
            <div class="panel-title">Inbound (入库单) <i class="fas fa-dolly"></i></div>
            <div class="input-group">
                <label class="label">Name (名称) <span class="req-star active">*</span></label>
                <div class="input-wrapper">
                    <input id="in-name" class="input" oninput="app.showSuggestions(this, 'in')" placeholder="Search or Type..." autocomplete="off">
                    <button class="trans-btn" onclick="app.translateInput('in-name')" title="Online Translate"><i class="fas fa-language"></i></button>
                    <div id="in-name-suggestions" class="suggestion-list"></div>
                </div>
                <div id="in-stock-hint" class="info-hint"></div>
                
                <div style="display:flex; gap:12px; margin-top:10px;">
                    <div style="flex:1"><label class="label">Qty (数量) <span class="req-star active">*</span></label><input type="number" id="in-qty" class="input" autocomplete="off"></div>
                    <div style="flex:1">
                        <label class="label">Unit (单位)</label>
                        <select id="in-unit" class="select"><option value="">Select...</option></select>
                    </div>
                </div>
                <div style="margin-top:10px;">
                    <label class="label">Loc (库位) <span class="req-star active">*</span></label>
                    <select id="in-loc" class="select"><option value="">Select...</option></select>
                </div>
                <button class="btn btn-in" style="margin-top:15px;" onclick="app.addToCart('in')"><i class="fas fa-plus"></i> Add to List (加入清单)</button>
            </div>
            <div class="cart-area">
                <table class="cart-table">
                    <thead><tr><th>Name (名)</th><th>Qty (数)</th><th>Loc (位)</th><th></th></tr></thead>
                    <tbody id="in-cart-list"></tbody>
                </table>
                <div id="in-cart-empty" style="text-align:center; padding:15px; color:#6e7681; font-size:11px;">List Empty (清单为空)</div>
            </div>
            <div>
                <label class="label">Handler (经手人) <span class="req-star req-in_handler">*</span></label>
                <div class="input-wrapper" style="margin-bottom:10px;">
                    <input id="in-handler" class="input" list="dl-handlers" autocomplete="off">
                    <button class="trans-btn" onclick="app.translateInput('in-handler')" title="Online Translate"><i class="fas fa-language"></i></button>
                </div>
                
                <label class="label">Source (来源/备注) <span class="req-star req-in_source">*</span></label>
                <div class="input-wrapper" style="margin-bottom:10px;">
                    <input id="in-source" class="input" autocomplete="off">
                    <button class="trans-btn" onclick="app.translateInput('in-source')" title="Online Translate"><i class="fas fa-language"></i></button>
                </div>

                <label class="label">Sign (签字) <span class="req-star active">*</span></label>
                <img id="in-prev" class="media-prev">
                <button class="btn" style="background:#21262d; color:#c9d1d9; border:1px solid #30363d; margin-bottom:15px;" onclick="app.openSign('in')"><i class="fas fa-pen-nib"></i> Tap to Sign (点击签字)</button>
                <button class="btn btn-success" id="btn-in-submit" onclick="app.submitBatch('in')" disabled>Submit Batch (批量提交)</button>
            </div>
        </div>

        <div id="panel-out" class="panel-box">
            <div class="panel-title">Outbound (出库单) <i class="fas fa-box-open"></i></div>
            <div class="input-group">
                <label class="label">Name (名称) <span class="req-star active">*</span></label>
                <div class="input-wrapper">
                    <input id="out-name" class="input" oninput="app.showSuggestions(this, 'out')" placeholder="Search..." autocomplete="off">
                    <button class="trans-btn" onclick="app.translateInput('out-name')" title="Online Translate"><i class="fas fa-language"></i></button>
                    <div id="out-name-suggestions" class="suggestion-list"></div>
                </div>
                <div id="stock-hint" class="info-hint"></div>
                <div style="display:flex; gap:12px; margin-top:10px;">
                    <div style="flex:1"><label class="label">Qty (数量) <span class="req-star active">*</span></label><input type="number" id="out-qty" class="input" autocomplete="off"></div>
                    <div style="flex:1">
                        <label class="label">Unit (单位)</label>
                        <input id="out-unit" class="input" disabled style="opacity: 1; border-color: #30363d; color: #8b949e;">
                    </div>
                </div>
                <button class="btn btn-out" style="margin-top:15px;" onclick="app.addToCart('out')"><i class="fas fa-plus"></i> Add to List (加入清单)</button>
            </div>
            <div class="cart-area">
                <table class="cart-table">
                    <thead><tr><th>Name (名)</th><th>Qty (数)</th><th></th></tr></thead>
                    <tbody id="out-cart-list"></tbody>
                </table>
                <div id="out-cart-empty" style="text-align:center; padding:15px; color:#6e7681; font-size:11px;">List Empty (清单为空)</div>
            </div>
            <div>
                <label class="label">Dept (部门) <span class="req-star req-out_dept">*</span></label>
                <select id="out-dept" class="select" style="margin-bottom:10px;"><option value="">Select...</option></select>
                
                <label class="label">Receiver (领用人) <span class="req-star req-out_receiver">*</span></label>
                <div class="input-wrapper" style="margin-bottom:10px;">
                    <input id="out-receiver" class="input" list="dl-receivers" autocomplete="off">
                    <button class="trans-btn" onclick="app.translateInput('out-receiver')" title="Online Translate"><i class="fas fa-language"></i></button>
                </div>

                <label class="label">Usage (用途) <span class="req-star req-out_usage">*</span></label>
                <div class="input-wrapper" style="margin-bottom:10px;">
                    <input id="out-usage" class="input" autocomplete="off">
                    <button class="trans-btn" onclick="app.translateInput('out-usage')" title="Online Translate"><i class="fas fa-language"></i></button>
                </div>

                <label class="label">Sign (签字) <span class="req-star active">*</span></label>
                <img id="out-prev" class="media-prev">
                <button class="btn" style="background:#21262d; color:#c9d1d9; border:1px solid #30363d; margin-bottom:15px;" onclick="app.openSign('out')"><i class="fas fa-pen-nib"></i> Tap to Sign (点击签字)</button>
                <button class="btn btn-success" id="btn-out-submit" onclick="app.submitBatch('out')" disabled>Submit Batch (批量提交)</button>
            </div>
        </div>

        <div id="panel-rules" class="panel-box">
            <div class="panel-title">Rules Settings (规则设置) <i class="fas fa-tasks"></i></div>
            <div style="margin-bottom:20px;">
                <div style="font-weight:700; color:var(--primary); margin-bottom:10px; border-bottom:1px solid #30363d; padding-bottom:5px;">Required Fields (必填项)</div>
                <div class="switch-row"><span>Handler (入库-经手)</span><label class="switch"><input type="checkbox" onchange="app.toggleRule('in_handler', this.checked)" id="sw-in_handler" checked><span class="slider"></span></label></div>
                <div class="switch-row"><span>Source (入库-来源)</span><label class="switch"><input type="checkbox" onchange="app.toggleRule('in_source', this.checked)" id="sw-in_source" checked><span class="slider"></span></label></div>
                <div class="switch-row"><span>Dept (出库-部门)</span><label class="switch"><input type="checkbox" onchange="app.toggleRule('out_dept', this.checked)" id="sw-out_dept" checked><span class="slider"></span></label></div>
                <div class="switch-row"><span>Receiver (出库-领用)</span><label class="switch"><input type="checkbox" onchange="app.toggleRule('out_receiver', this.checked)" id="sw-out_receiver" checked><span class="slider"></span></label></div>
                <div class="switch-row"><span>Usage (出库-用途)</span><label class="switch"><input type="checkbox" onchange="app.toggleRule('out_usage', this.checked)" id="sw-out_usage" checked><span class="slider"></span></label></div>
            </div>
        </div>
    </div>

    <div id="modal-report-center" class="full-modal">
        <div class="fm-header">
            <div><h3>Report Center</h3><span>报表中心</span></div>
            <div class="icon-btn" onclick="app.closeReportCenter()"><i class="fas fa-times"></i></div>
        </div>
        <div class="fm-body">
            <div class="filter-bar">
                <span style="margin-left:8px"><i class="fas fa-filter"></i> Filter (筛选):</span>
                <input id="rep-search" placeholder="Search (名称/人/位)..." oninput="app.renderReport()" autocomplete="off">
                <input type="date" id="rep-start" onchange="app.renderReport()" title="Start Date">
                <input type="date" id="rep-end" onchange="app.renderReport()" title="End Date" style="margin-right:8px">
            </div>

            <div class="fm-nav">
                <div class="fm-tab" id="tab-in" onclick="app.switchTab('in')">
                    <i class="fas fa-arrow-circle-down"></i><span>Inbound (入库)</span>
                </div>
                <div class="fm-tab" id="tab-out" onclick="app.switchTab('out')">
                    <i class="fas fa-arrow-circle-up"></i><span>Outbound (出库)</span>
                </div>
                <div class="fm-tab" id="tab-stock" onclick="app.switchTab('stock')">
                    <i class="fas fa-cubes"></i><span>Stock (库存)</span>
                </div>
            </div>

            <div class="table-scroll-container">
                <table class="report-table" id="rep-table"></table>
            </div>
            
            <div style="margin-top:auto; padding:16px; background:var(--bg); border-top:1px solid var(--border); display:flex; gap:12px; flex-shrink:0;">
                <button class="btn btn-danger" onclick="app.exportPDF()"><i class="fas fa-file-pdf"></i> PDF (Save)</button>
                <button class="btn btn-success" onclick="app.exportExcel()"><i class="fas fa-file-excel"></i> Excel</button>
            </div>
        </div>
    </div>

    <div id="modal-admin-ultimate" class="full-modal">
        <div class="fm-header" style="background:#0d1117; color:white;">
            <div><h3 style="margin:0; font-size:16px;">Admin Center</h3><span style="font-size:10px; opacity:0.7">God Mode (上帝权限)</span></div>
            <div style="display:flex; gap:10px; align-items:center;">
                <button class="btn btn-success" style="height:30px; padding:0 12px; font-size:12px;" onclick="app.adminManualSave()"><i class="fas fa-save"></i> Save</button>
                <i class="fas fa-times" style="font-size:20px; cursor:pointer" onclick="document.getElementById('modal-admin-ultimate').style.display='none'"></i>
            </div>
        </div>
        
        <div class="god-nav-bar">
            <div class="god-nav-grid">
                <div class="god-card active" id="at-stock" onclick="app.switchAdminTab('stock')"><i class="fas fa-cubes"></i><span>Stock (物资)</span></div>
                <div class="god-card" id="at-logs" onclick="app.switchAdminTab('logs')"><i class="fas fa-history"></i><span>Logs (记录)</span></div>
                <div class="god-card" id="at-data" onclick="app.switchAdminTab('data')"><i class="fas fa-database"></i><span>Data (数据)</span></div>
                <div class="god-card" id="at-sys" onclick="app.switchAdminTab('sys')"><i class="fas fa-cogs"></i><span>System (系统)</span></div>
            </div>
        </div>

        <div class="fm-body">
            
            <div id="adm-area-stock" class="panel-box" style="display:block;">
                <div class="admin-sticky-header">
                    <div style="background:#21262d; padding:10px; border-radius:6px; margin-bottom:10px; border:1px solid var(--border);">
                        <div style="display:grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap:8px;">
                            <div class="input-wrapper"><input id="new-name" class="input" placeholder="Name (名称)" autocomplete="off"><button class="trans-btn" onclick="app.translateInput('new-name')"><i class="fas fa-language"></i></button></div>
                            <input id="new-qty" type="number" class="input" placeholder="Qty (数)" autocomplete="off">
                            <select id="new-unit" class="select"><option value="">Unit (单)...</option></select>
                            <select id="new-loc" class="select"><option value="">Loc (位)...</option></select>
                            <button class="btn btn-success" style="width:auto; padding:8px" onclick="app.admAddStock()"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>
                    <div class="filter-bar" style="padding:0; border:none; background:transparent;">
                        <input id="filter-stock-name" placeholder="Name (名称)..." oninput="app.admRenderStock()" autocomplete="off">
                        <input id="filter-stock-loc" placeholder="Loc (库位)..." oninput="app.admRenderStock()" autocomplete="off">
                    </div>
                </div>
                <div class="admin-scroll-content">
                    <table class="report-table" style="width:100%">
                        <thead><tr><th>Name (名称)</th><th>Qty (数)</th><th>Unit (单)</th><th>Loc (位)</th><th>Act (操)</th></tr></thead>
                        <tbody id="adm-stock-list"></tbody>
                    </table>
                </div>
            </div>

            <div id="adm-area-logs" class="panel-box" style="display:none;">
                <div class="admin-sticky-header">
                    <div class="filter-bar" style="padding:0; border:none; background:transparent;">
                        <select id="adm-log-type" onchange="app.admRenderLogs()"><option value="ALL">All (全)</option><option value="IN">In (入)</option><option value="OUT">Out (出)</option></select>
                        <input id="adm-log-search" placeholder="Search (搜)..." oninput="app.admRenderLogs()" autocomplete="off">
                        <input type="date" id="adm-log-start" onchange="app.admRenderLogs()">
                        <input type="date" id="adm-log-end" onchange="app.admRenderLogs()">
                    </div>
                </div>
                <div class="admin-scroll-content">
                    <table class="report-table" style="width:100%">
                        <thead><tr><th>Time (时)</th><th>Type (类)</th><th>Name (名)</th><th>Qty (数)</th><th>Loc/Dept (位/部)</th><th>Note (源/途)</th><th>Sig (签)</th><th>Act (操)</th></tr></thead>
                        <tbody id="adm-logs-list"></tbody>
                    </table>
                </div>
            </div>

            <div id="adm-area-data" class="panel-box" style="display:none;">
                <div class="admin-scroll-content">
                    <div class="data-grid-container">
                        <div class="data-section">
                            <h4>Locations (库位)</h4>
                            <div class="ds-input-row">
                                <input id="new-loc-val" class="input" placeholder="New Loc (新库位)..." autocomplete="off">
                                <button class="btn btn-success" style="width:auto; padding:4px 10px;" onclick="app.admAddLoc()"><i class="fas fa-plus"></i></button>
                            </div>
                            <div class="ds-table-wrap">
                                <table class="report-table">
                                    <tbody id="adm-loc-list"></tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="data-section">
                            <h4>Units (单位)</h4>
                            <div class="ds-input-row">
                                <input id="new-unit-val" class="input" placeholder="New Unit (新单位)..." autocomplete="off">
                                <button class="btn btn-success" style="width:auto; padding:4px 10px;" onclick="app.admAddUnit()"><i class="fas fa-plus"></i></button>
                            </div>
                            <div class="ds-table-wrap">
                                <table class="report-table">
                                    <tbody id="adm-unit-list"></tbody>
                                </table>
                            </div>
                        </div>

                        <div class="data-section">
                            <h4>Departments (部门)</h4>
                            <div class="ds-input-row">
                                <div class="input-wrapper">
                                    <input id="new-dept" class="input" placeholder="New Dept (新部门)..." autocomplete="off">
                                    <button class="trans-btn" onclick="app.translateInput('new-dept')"><i class="fas fa-language"></i></button>
                                </div>
                                <button class="btn btn-success" style="width:auto; padding:4px 10px;" onclick="app.admAddDept()"><i class="fas fa-plus"></i></button>
                            </div>
                            <div class="ds-table-wrap">
                                <table class="report-table">
                                    <tbody id="adm-dept-list"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="adm-area-sys" class="panel-box" style="display:none;">
                <div class="admin-scroll-content">
                    <div style="margin-bottom:20px; background:#21262d; padding:15px; border-radius:6px;">
                        <div style="font-weight:700; margin-bottom:10px; color:#58a6ff">Force Sync (强制同步)</div>
                        <p style="font-size:11px; color:#8b949e; margin-bottom:10px;">Use this ONLY if Cloud data is wrong or outdated. (仅当云端数据错误时使用)</p>
                        <button class="btn btn-primary" onclick="app.forcePushToCloud()">Force Push Local to Cloud (强制上传本地数据)</button>
                    </div>

                    <div style="margin-bottom:20px; background:#21262d; padding:15px; border-radius:6px;">
                        <div style="font-weight:700; margin-bottom:10px;">Data Backup (数据备份)</div>
                        <button class="btn btn-in" onclick="app.backupData()">Backup (备份)</button>
                        <input type="file" id="file-restore" hidden onchange="app.restoreData(this)">
                        <button class="btn btn-out" style="margin-top:10px" onclick="document.getElementById('file-restore').click()">Restore (恢复)</button>
                    </div>
                    
                    <div style="margin-bottom:20px; background:#21262d; padding:15px; border-radius:6px; border:1px solid var(--border);">
                        <label class="label">Reset Keeper Password (重置库管员密码)</label>
                        <div style="display:flex; gap:10px;">
                            <input id="new-pass-keeper" class="input" placeholder="New Keeper Password" autocomplete="off">
                            <button class="btn btn-primary" style="width:auto" onclick="app.changePassword('keeper')">Update (更新)</button>
                        </div>
                    </div>

                    <div style="margin-bottom:20px;">
                        <div style="font-weight:700; color:var(--primary); margin-bottom:15px; border-bottom:1px solid #30363d; padding-bottom:5px;">Security (安全)</div>
                        <div style="margin-bottom:15px; background:#21262d; padding:15px; border-radius:6px; border:1px solid var(--border);">
                            <label class="label">Change Admin Password (修改管理员密码)</label>
                            <div style="display:flex; gap:10px;">
                                <input id="new-pass-admin" class="input" placeholder="New Password" autocomplete="off">
                                <button class="btn btn-primary" style="width:auto" onclick="app.changePassword('admin')">Update (更新)</button>
                            </div>
                        </div>
                        <div style="margin-bottom:15px; background:#21262d; padding:15px; border-radius:6px; border:1px solid var(--border);">
                            <label class="label">Change God Password (修改上帝密码)</label>
                            <div style="display:flex; gap:10px;">
                                <input id="new-pass-god" class="input" placeholder="New God Password" autocomplete="off">
                                <button class="btn btn-danger" style="width:auto" onclick="app.changePassword('god')">Update (更新)</button>
                            </div>
                        </div>
                    </div>
                    <div>
                        <div style="font-weight:700; color:#ef4444; margin-bottom:10px; border-bottom:1px solid #30363d; padding-bottom:5px;">Danger Zone (危险区)</div>
                        <button class="btn btn-danger" onclick="app.resetData()">⚠️ Reset All Data (清空所有数据)</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="modal-sign">
        <div class="modal-box big-sign">
            <button class="modal-close-btn" onclick="app.closeSign()"><i class="fas fa-times"></i></button>
            <h3 style="text-align:center;color:var(--text)">Sign Below (请在下方签字)</h3>
            <canvas id="sig-canvas" class="sig-canvas"></canvas>
            <div style="display:flex;gap:15px;margin-top:10px;">
                <button class="btn" style="flex:1;background:#21262d;color:var(--text)" onclick="app.closeSign()">Cancel (取消)</button>
                <button class="btn" style="flex:1;background:#21262d;color:var(--text)" onclick="app.clearSig()">Clear (清除)</button>
                <button class="btn btn-primary" style="flex:2" onclick="app.saveSig()">Confirm (确认)</button>
            </div>
        </div>
    </div>
    
    <div id="toast-msg"><i class="fas fa-check-circle"></i> Sync Success!</div>
    <datalist id="dl-handlers"></datalist><datalist id="dl-receivers"></datalist>
    <div id="print-area"></div>
    
    <script src="app.js"></script>
</body>
</html>
