<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KMC后勤物资 (Smart Sync v3.3 Final Fixed)</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* KMC V21.0 - Dark Theme CSS (已内置，防止样式丢失) */
        :root { --bg: #0d1117; --panel: #161b22; --border: #30363d; --text: #c9d1d9; --text-muted: #8b949e; --primary: #58a6ff; --btn-green: #238636; --danger: #da3633; --in: #238636; --out: #1f6feb; }
        * { box-sizing: border-box; }
        body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; font-size: 13px; }
        .hidden { display: none !important; }
        .header { background: var(--panel) !important; padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); z-index: 20; flex-shrink: 0; }
        .brand { display: flex; align-items: center; gap: 8px; font-weight: 700; font-size: 18px; color: var(--text); cursor: pointer; user-select: none; }
        .header-actions { display: flex; gap: 10px; align-items: center; }
        .icon-btn { width: 32px; height: 32px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 14px; cursor: pointer; transition: 0.2s; background: transparent; border: 1px solid var(--border); color: var(--text-muted); }
        .icon-btn:hover { background: #21262d; color: var(--text); border-color: var(--text-muted); }
        .icon-btn.sync.success { color: #3fb950; border-color: #3fb950; background: rgba(63, 185, 80, 0.1); }
        .icon-btn.sync.spinning { animation: spin 1s infinite linear; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .action-grid-wrapper { flex-shrink: 0; background: var(--bg); padding: 10px 16px; border-bottom: 1px solid var(--border); z-index: 15; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .action-card { background: var(--panel); padding: 12px; border-radius: 6px; cursor: pointer; text-align: center; border: 1px solid var(--border); transition: 0.2s; color: var(--text); }
        .action-card span { font-size: 11px; font-weight: 600; display: block; margin-top: 6px; color: var(--text-muted); }
        .action-card.active { border-color: #1f6feb; background: #1f2937; }
        .action-card.active span { color: var(--text); }
        .main-scroll { flex: 1; overflow-y: auto; padding: 16px; scroll-behavior: smooth; }
        .panel-box { background: var(--panel) !important; border: 1px solid var(--border); border-radius: 6px; padding: 16px; margin-bottom: 20px; display: none; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from {opacity:0; transform:translateY(3px);} to {opacity:1; transform:translateY(0);} }
        .panel-title { font-size: 14px; font-weight: 700; color: var(--text); margin: 0 0 12px 0; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 8px; }
        .input-group { margin-bottom: 12px; }
        .label { font-size: 11px; font-weight: 600; color: var(--text-muted); margin-bottom: 4px; display: block; }
        .req-star { color: var(--danger); margin-left: 2px; display: none; } .req-star.active { display: inline; }
        .input-wrapper { display: flex; gap: 5px; width: 100%; position: relative; }
        .suggestion-list { position: absolute; top: 100%; left: 0; right: 39px; background: #161b22; border: 1px solid #30363d; border-top: none; border-radius: 0 0 6px 6px; max-height: 180px; overflow-y: auto; z-index: 100; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.5); }
        .suggestion-item { padding: 8px 10px; cursor: pointer; border-bottom: 1px solid #21262d; font-size: 12px; color: #c9d1d9; }
        .suggestion-item:hover { background: #1f6feb; color: white; }
        .trans-btn { width: 34px; height: 34px; border-radius: 6px; background: #21262d; border: 1px solid var(--border); color: var(--text-muted); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; flex-shrink: 0; }
        .trans-btn:hover { background: var(--primary); color: white; border-color: var(--primary); }
        .input, .select { width: 100%; padding: 6px 10px; height: 34px; border: 1px solid var(--border); background: #010409 !important; font-size: 13px; color: var(--text); border-radius: 6px; transition: 0.2s; }
        .input:focus { outline: none; border-color: var(--primary); }
        .input:disabled { background: #161b22 !important; color: #8b949e; cursor: not-allowed; opacity: 1; border-color: #30363d; }
        .btn { width: 100%; padding: 0 16px; height: 34px; border: 1px solid rgba(240, 246, 252, 0.1); border-radius: 6px; font-weight: 600; font-size: 13px; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 6px; transition: 0.2s; font-family: inherit; }
        .btn:active { opacity: 0.8; transform: scale(0.99); }
        .btn-in, .btn-primary, .btn-success { background: var(--btn-green) !important; color: white !important; }
        .btn-out { background: #21262d; color: var(--primary); border-color: var(--border); }
        .btn-danger { background: var(--danger); color: white; border-color: rgba(240,246,252,0.1); }
        .btn:disabled { background: #21262d !important; color: #484f58 !important; border-color: var(--border); cursor: not-allowed; opacity: 0.6; }
        .cart-area { margin: 12px 0; border: 1px solid var(--border); border-radius: 6px; background: #010409; overflow: hidden; }
        .cart-table { width: 100%; font-size: 12px; border-collapse: collapse; }
        .cart-table th { text-align: left; background: #21262d; color: var(--text-muted); padding: 8px 10px; border-bottom: 1px solid var(--border); font-weight: 600; }
        .cart-table td { padding: 8px 10px; border-bottom: 1px solid var(--border); color: var(--text); }
        .del-btn { color: #f85149; cursor: pointer; padding: 4px; }
        .full-modal { position: fixed; inset: 0; background: var(--bg); z-index: 5000; display: none; flex-direction: column; }
        .fm-header { flex-shrink: 0; padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: var(--panel) !important; z-index: 20; }
        .fm-body { flex: 1; overflow-y: auto; padding: 16px; background: var(--bg); position: relative; }
        .fm-nav { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 16px; }
        .fm-tab { background: var(--panel); border: 1px solid var(--border); border-radius: 8px; padding: 12px 4px; text-align: center; cursor: pointer; }
        .fm-tab.active { background: #1f6feb; border-color: #1f6feb; color: white; }
        .fm-tab.active span, .fm-tab.active i { color: white; }
        .fm-tab i { font-size: 16px; color: var(--text-muted); display:block; margin-bottom: 4px; }
        .fm-tab span { font-size: 11px; font-weight: 600; color: var(--text-muted); }
        .filter-bar { display: flex; gap: 8px; background: var(--bg); padding-bottom: 10px; flex-wrap: wrap; align-items: center; border-bottom: 1px solid var(--border); margin-bottom: 10px; }
        .report-table { width: 100%; border-collapse: collapse; font-size: 12px; background: var(--panel); margin-top: 10px; }
        .report-table th { background: #21262d; color: var(--text); border: 1px solid var(--border); padding: 10px; white-space: nowrap; text-align: center; }
        .report-table td { border: 1px solid var(--border); padding: 8px 10px; text-align: center; vertical-align: middle; color: var(--text); }
        .sig-thumb { height: 30px; vertical-align: middle; background: white; padding: 2px; border-radius: 4px; border: 1px solid #ccc; display:inline-block; }
        .god-nav-bar { flex-shrink: 0; background: var(--bg); padding: 10px 16px; border-bottom: 1px solid var(--border); }
        .god-nav-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 8px; }
        .god-card { background: var(--panel); border: 1px solid var(--border); border-radius: 6px; padding: 8px 2px; text-align: center; cursor: pointer; opacity: 0.6; }
        .god-card.active { opacity: 1; border-color: var(--primary); background: #1f2937; }
        .god-card i { font-size: 14px; margin-bottom: 4px; display: block; color: var(--text-muted); }
        .god-card span { font-size: 9px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; }
        .adm-input { width: 100%; border: 1px solid transparent; background: transparent; text-align: center; font-size: 12px; color: var(--text); padding: 4px; }
        .adm-input:focus { border: 1px solid var(--primary); background: #0d1117; border-radius: 4px; outline: none; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 6000; display: none; justify-content: center; align-items: center; }
        .modal-box.big-sign { width: 95%; height: 85vh; background: var(--panel); padding: 15px; border-radius: 12px; display: flex; flex-direction: column; border: 1px solid var(--border); }
        .sig-canvas { flex: 1; width: 100%; background: #ffffff; border: 2px dashed var(--border); border-radius: 6px; cursor: crosshair; }
        .media-prev { width: 100%; height: 60px; object-fit: contain; border: 1px solid var(--border); border-radius: 4px; margin-bottom: 12px; display: none; background: #fff; }
        .media-prev.show { display: block; }
        .modal-close-btn { position: absolute; top: 10px; right: 10px; width: 30px; height: 30px; background: #da3633; color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; z-index: 10; border: none; font-size: 16px; }
        .switch-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border); }
        .switch { position: relative; display: inline-block; width: 36px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #30363d; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #238636; }
        input:checked + .slider:before { transform: translateX(16px); }
        #login-screen > div { background: var(--panel) !important; border: 1px solid var(--border); box-shadow: 0 0 40px rgba(0,0,0,0.6) !important; color: var(--text); }
        .info-hint { font-size:11px; margin-top:6px; display:none; padding:6px 10px; background:#161b22; border:1px solid #30363d; border-radius:4px; color:#c9d1d9; border-left: 3px solid var(--primary); }
        .info-hint b { color: var(--primary); }
        #toast-msg { position: fixed; bottom: 30px; right: 20px; background: #238636; color: white; padding: 12px 20px; border-radius: 8px; font-size: 13px; font-weight: 600; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 7000; opacity: 0; transform: translateY(20px); transition: 0.3s; pointer-events: none; }
        #toast-msg.show { transform: translateY(0); opacity: 1; }
        #print-area { position: fixed; top: 0; left: 0; z-index: -9999; width: 1100px; padding: 40px; background: white !important; color: black !important; visibility: visible; font-family: 'Inter', sans-serif; }
        #print-area table { width: 100%; border-collapse: collapse; border: 2px solid #000; margin-top: 15px; }
        #print-area th { background: #f0f0f0 !important; color: #000 !important; border: 1px solid #000; padding: 12px 8px; text-align: center; font-weight: bold; font-size: 12px; }
        #print-area td { border: 1px solid #000; padding: 10px 8px; color: #000 !important; background: #fff !important; text-align: center; vertical-align: middle; font-size: 11px; }
        #print-area .sig-thumb { display: inline-block !important; width: auto; height: 50px; background: white; border: 1px solid #ccc; }
        #print-area .batch-item-row { border-bottom: 1px solid #ccc; padding: 2px 0; }
        #print-area .batch-qty { font-weight: bold; }
        #print-area h2 { color: #000 !important; margin: 0 0 5px 0; text-align: center; font-size: 24px; text-transform: uppercase; }
        #print-area .meta { color: #333; font-size: 11px; margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom: 10px; text-align: right; }
        /* Sticky Header for Admin Tables */
        .admin-sticky-header { position: sticky; top: 0; z-index: 10; background: var(--bg); padding-bottom: 10px; border-bottom: 1px solid var(--border); }
        .admin-scroll-content { overflow-y: auto; max-height: calc(100vh - 200px); }
    </style>
</head>
<body>

    <div id="login-screen" style="position:fixed; inset:0; background: var(--bg); z-index:4000; display:flex; justify-content:center; align-items:center;">
        <div style="background: var(--panel); padding:30px; width:300px; border-radius:12px; text-align:center;">
            <div style="font-size:36px; margin-bottom:12px;"><i class="fas fa-cubes" style="color:var(--text)"></i></div>
            <h2 style="margin:0 0 5px 0; color:var(--text)">KMC后勤物资</h2>
            <p style="font-size:12px; color:var(--text-muted); margin-bottom:24px;">KMC Logistics (Smart Sync V3.3)</p>
            <div style="text-align:left; margin-bottom:15px;">
                <label class="label">Role (身份)</label>
                <select id="login-role" class="select" onchange="app.roleSwitch(this.value)">
                    <option value="keeper">Warehouse Keeper (库管员)</option>
                    <option value="admin">Admin (管理员)</option>
                </select>
            </div>
            <div id="pass-area" style="text-align:left; margin-bottom:24px;">
                <label class="label">Password (密码)</label>
                <input type="password" id="login-pass" class="input" autocomplete="off">
            </div>
            <button class="btn btn-primary" onclick="app.login()">Enter System (进入系统)</button>
        </div>
    </div>

    <header class="header">
        <div class="brand" onclick="app.triggerAdmin()" title="Tap 7 times for God Mode"><i class="fas fa-cube"></i> KMC <span id="user-badge" style="font-size:10px; background:#1f6feb; color:white; padding:2px 8px; border-radius:4px; font-weight:700;"></span></div>
        <div class="header-actions">
            <div class="icon-btn sync" id="cloud-btn" onclick="app.smartSync()" title="Smart Sync (智能同步)"><i class="fas fa-cloud"></i></div>
            <div class="icon-btn exit" onclick="location.reload()"><i class="fas fa-sign-out-alt"></i></div>
        </div>
    </header>

    <div class="action-grid-wrapper">
        <div class="action-grid">
            <div class="action-card" onclick="app.togglePanel('in')" id="card-in">
                <i class="fas fa-arrow-circle-down" style="color:var(--in)"></i>
                <span>Inbound<br>(入库)</span>
            </div>
            <div class="action-card" onclick="app.togglePanel('out')" id="card-out">
                <i class="fas fa-arrow-circle-up" style="color:var(--out)"></i>
                <span>Outbound<br>(出库)</span>
            </div>
            <div class="action-card" onclick="app.openReportCenter()">
                <i class="fas fa-chart-pie" style="color:#a371f7"></i>
                <span>Reports<br>(报表)</span>
            </div>
            <div class="action-card" onclick="app.togglePanel('rules')" id="card-rules" style="display:none;">
                <i class="fas fa-tasks" style="color:#e2e8f0"></i>
                <span>Rules<br>(规则)</span>
            </div>
        </div>
    </div>

    <div class="main-scroll">
        <div id="panel-in" class="panel-box">
            <div class="panel-title">Inbound (入库单) <i class="fas fa-dolly"></i></div>
            <div class="input-group">
                <label class="label">Name (名称) <span class="req-star active">*</span></label>
                <div class="input-wrapper">
                    <input id="in-name" class="input" oninput="app.showSuggestions(this, 'in')" placeholder="Search or Type..." autocomplete="off">
                    <button class="trans-btn" onclick="app.translateInput('in-name')" title="Online Translate"><i class="fas fa-language"></i></button>
                    <div id="in-name-suggestions" class="suggestion-list"></div>
                </div>
                <div id="in-stock-hint" class="info-hint"></div>
                
                <div style="display:flex; gap:12px; margin-top:10px;">
                    <div style="flex:1"><label class="label">Qty (数量) <span class="req-star active">*</span></label><input type="number" id="in-qty" class="input" autocomplete="off"></div>
                    <div style="flex:1">
                        <label class="label">Unit (单位)</label>
                        <select id="in-unit" class="select"><option value="">Select...</option></select>
                    </div>
                </div>
                <div style="margin-top:10px;">
                    <label class="label">Loc (库位) <span class="req-star active">*</span></label>
                    <select id="in-loc" class="select"><option value="">Select...</option></select>
                </div>
                <button class="btn btn-in" style="margin-top:15px;" onclick="app.addToCart('in')"><i class="fas fa-plus"></i> Add to List (加入清单)</button>
            </div>
            <div class="cart-area">
                <table class="cart-table">
                    <thead><tr><th>Name (名)</th><th>Qty (数)</th><th>Loc (位)</th><th></th></tr></thead>
                    <tbody id="in-cart-list"></tbody>
                </table>
                <div id="in-cart-empty" style="text-align:center; padding:15px; color:#6e7681; font-size:11px;">List Empty (清单为空)</div>
            </div>
            <div>
                <label class="label">Handler (经手人) <span class="req-star req-in_handler">*</span></label>
                <div class="input-wrapper" style="margin-bottom:10px;">
                    <input id="in-handler" class="input" list="dl-handlers" autocomplete="off">
                    <button class="trans-btn" onclick="app.translateInput('in-handler')" title="Online Translate"><i class="fas fa-language"></i></button>
                </div>
                
                <label class="label">Source (来源/备注) <span class="req-star req-in_source">*</span></label>
                <div class="input-wrapper" style="margin-bottom:10px;">
                    <input id="in-source" class="input" autocomplete="off">
                    <button class="trans-btn" onclick="app.translateInput('in-source')" title="Online Translate"><i class="fas fa-language"></i></button>
                </div>

                <label class="label">Sign (签字) <span class="req-star active">*</span></label>
                <img id="in-prev" class="media-prev">
                <button class="btn" style="background:#21262d; color:#c9d1d9; border:1px solid #30363d; margin-bottom:15px;" onclick="app.openSign('in')"><i class="fas fa-pen-nib"></i> Tap to Sign (点击签字)</button>
                <button class="btn btn-success" id="btn-in-submit" onclick="app.submitBatch('in')" disabled>Submit Batch (批量提交)</button>
            </div>
        </div>

        <div id="panel-out" class="panel-box">
            <div class="panel-title">Outbound (出库单) <i class="fas fa-box-open"></i></div>
            <div class="input-group">
                <label class="label">Name (名称) <span class="req-star active">*</span></label>
                <div class="input-wrapper">
                    <input id="out-name" class="input" oninput="app.showSuggestions(this, 'out')" placeholder="Search..." autocomplete="off">
                    <button class="trans-btn" onclick="app.translateInput('out-name')" title="Online Translate"><i class="fas fa-language"></i></button>
                    <div id="out-name-suggestions" class="suggestion-list"></div>
                </div>
                <div id="stock-hint" class="info-hint"></div>
                <div style="display:flex; gap:12px; margin-top:10px;">
                    <div style="flex:1"><label class="label">Qty (数量) <span class="req-star active">*</span></label><input type="number" id="out-qty" class="input" autocomplete="off"></div>
                    <div style="flex:1">
                        <label class="label">Unit (单位)</label>
                        <input id="out-unit" class="input" disabled style="opacity: 1; border-color: #30363d; color: #8b949e;">
                    </div>
                </div>
                <button class="btn btn-out" style="margin-top:15px;" onclick="app.addToCart('out')"><i class="fas fa-plus"></i> Add to List (加入清单)</button>
            </div>
            <div class="cart-area">
                <table class="cart-table">
                    <thead><tr><th>Name (名)</th><th>Qty (数)</th><th></th></tr></thead>
                    <tbody id="out-cart-list"></tbody>
                </table>
                <div id="out-cart-empty" style="text-align:center; padding:15px; color:#6e7681; font-size:11px;">List Empty (清单为空)</div>
            </div>
            <div>
                <label class="label">Dept (部门) <span class="req-star req-out_dept">*</span></label>
                <select id="out-dept" class="select" style="margin-bottom:10px;"><option value="">Select...</option></select>
                
                <label class="label">Receiver (领用人) <span class="req-star req-out_receiver">*</span></label>
                <div class="input-wrapper" style="margin-bottom:10px;">
                    <input id="out-receiver" class="input" list="dl-receivers" autocomplete="off">
                    <button class="trans-btn" onclick="app.translateInput('out-receiver')" title="Online Translate"><i class="fas fa-language"></i></button>
                </div>

                <label class="label">Usage (用途) <span class="req-star req-out_usage">*</span></label>
                <div class="input-wrapper" style="margin-bottom:10px;">
                    <input id="out-usage" class="input" autocomplete="off">
                    <button class="trans-btn" onclick="app.translateInput('out-usage')" title="Online Translate"><i class="fas fa-language"></i></button>
                </div>

                <label class="label">Sign (签字) <span class="req-star active">*</span></label>
                <img id="out-prev" class="media-prev">
                <button class="btn" style="background:#21262d; color:#c9d1d9; border:1px solid #30363d; margin-bottom:15px;" onclick="app.openSign('out')"><i class="fas fa-pen-nib"></i> Tap to Sign (点击签字)</button>
                <button class="btn btn-success" id="btn-out-submit" onclick="app.submitBatch('out')" disabled>Submit Batch (批量提交)</button>
            </div>
        </div>

        <div id="panel-rules" class="panel-box">
            <div class="panel-title">Rules Settings (规则设置) <i class="fas fa-tasks"></i></div>
            <div style="margin-bottom:20px;">
                <div style="font-weight:700; color:var(--primary); margin-bottom:10px; border-bottom:1px solid #30363d; padding-bottom:5px;">Required Fields (必填项)</div>
                <div class="switch-row"><span>Handler (入库-经手)</span><label class="switch"><input type="checkbox" onchange="app.toggleRule('in_handler', this.checked)" id="sw-in_handler" checked><span class="slider"></span></label></div>
                <div class="switch-row"><span>Source (入库-来源)</span><label class="switch"><input type="checkbox" onchange="app.toggleRule('in_source', this.checked)" id="sw-in_source" checked><span class="slider"></span></label></div>
                <div class="switch-row"><span>Dept (出库-部门)</span><label class="switch"><input type="checkbox" onchange="app.toggleRule('out_dept', this.checked)" id="sw-out_dept" checked><span class="slider"></span></label></div>
                <div class="switch-row"><span>Receiver (出库-领用)</span><label class="switch"><input type="checkbox" onchange="app.toggleRule('out_receiver', this.checked)" id="sw-out_receiver" checked><span class="slider"></span></label></div>
                <div class="switch-row"><span>Usage (出库-用途)</span><label class="switch"><input type="checkbox" onchange="app.toggleRule('out_usage', this.checked)" id="sw-out_usage" checked><span class="slider"></span></label></div>
            </div>
        </div>
    </div>

    <div id="modal-report-center" class="full-modal">
        <div class="fm-header">
            <div><h3>Report Center</h3><span>报表中心</span></div>
            <div class="icon-btn" onclick="app.closeReportCenter()"><i class="fas fa-times"></i></div>
        </div>
        <div class="fm-body">
            <div class="filter-bar">
                <span style="margin-left:8px"><i class="fas fa-filter"></i> Filter (筛选):</span>
                <input id="rep-search" placeholder="Search (名称/人/位)..." oninput="app.renderReport()" autocomplete="off">
                <input type="date" id="rep-start" onchange="app.renderReport()" title="Start Date">
                <input type="date" id="rep-end" onchange="app.renderReport()" title="End Date" style="margin-right:8px">
            </div>

            <div class="fm-nav">
                <div class="fm-tab" id="tab-in" onclick="app.switchTab('in')">
                    <i class="fas fa-arrow-circle-down"></i><span>Inbound (入库)</span>
                </div>
                <div class="fm-tab" id="tab-out" onclick="app.switchTab('out')">
                    <i class="fas fa-arrow-circle-up"></i><span>Outbound (出库)</span>
                </div>
                <div class="fm-tab" id="tab-stock" onclick="app.switchTab('stock')">
                    <i class="fas fa-cubes"></i><span>Stock (库存)</span>
                </div>
            </div>

            <div class="table-scroll-container">
                <table class="report-table" id="rep-table"></table>
            </div>
            
            <div style="margin-top:auto; padding:16px; background:var(--bg); border-top:1px solid var(--border); display:flex; gap:12px; flex-shrink:0;">
                <button class="btn btn-danger" onclick="app.exportPDF()"><i class="fas fa-file-pdf"></i> PDF (Save)</button>
                <button class="btn btn-success" onclick="app.exportExcel()"><i class="fas fa-file-excel"></i> Excel</button>
            </div>
        </div>
    </div>

    <div id="modal-admin-ultimate" class="full-modal">
        <div class="fm-header" style="background:#0d1117; color:white;">
            <div><h3 style="margin:0; font-size:16px;">Admin Center</h3><span style="font-size:10px; opacity:0.7">God Mode (上帝权限)</span></div>
            <div style="display:flex; gap:10px; align-items:center;">
                <button class="btn btn-success" style="height:30px; padding:0 12px; font-size:12px;" onclick="app.adminManualSave()"><i class="fas fa-save"></i> Save</button>
                <i class="fas fa-times" style="font-size:20px; cursor:pointer" onclick="document.getElementById('modal-admin-ultimate').style.display='none'"></i>
            </div>
        </div>
        
        <div class="god-nav-bar">
            <div class="god-nav-grid">
                <div class="god-card active" id="at-stock" onclick="app.switchAdminTab('stock')"><i class="fas fa-cubes"></i><span>Stock (物资)</span></div>
                <div class="god-card" id="at-logs" onclick="app.switchAdminTab('logs')"><i class="fas fa-history"></i><span>Logs (记录)</span></div>
                <div class="god-card" id="at-data" onclick="app.switchAdminTab('data')"><i class="fas fa-database"></i><span>Data (数据)</span></div>
                <div class="god-card" id="at-sys" onclick="app.switchAdminTab('sys')"><i class="fas fa-cogs"></i><span>System (系统)</span></div>
            </div>
        </div>

        <div class="fm-body">
            
            <div id="adm-area-stock" class="panel-box" style="display:block;">
                <div class="admin-sticky-header">
                    <div style="background:#21262d; padding:10px; border-radius:6px; margin-bottom:10px; border:1px solid var(--border);">
                        <div style="display:grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap:8px;">
                            <div class="input-wrapper"><input id="new-name" class="input" placeholder="Name (名称)" autocomplete="off"><button class="trans-btn" onclick="app.translateInput('new-name')"><i class="fas fa-language"></i></button></div>
                            <input id="new-qty" type="number" class="input" placeholder="Qty (数)" autocomplete="off">
                            <select id="new-unit" class="select"><option value="">Unit (单)...</option></select>
                            <select id="new-loc" class="select"><option value="">Loc (位)...</option></select>
                            <button class="btn btn-success" style="width:auto; padding:8px" onclick="app.admAddStock()"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>
                    <div class="filter-bar" style="padding:0; border:none; background:transparent;">
                        <input id="filter-stock-name" placeholder="Name (名称)..." oninput="app.admRenderStock()" autocomplete="off">
                        <input id="filter-stock-loc" placeholder="Loc (库位)..." oninput="app.admRenderStock()" autocomplete="off">
                    </div>
                </div>
                <div class="admin-scroll-content">
                    <table class="report-table" style="width:100%">
                        <thead><tr><th>Name (名称)</th><th>Qty (数)</th><th>Unit (单)</th><th>Loc (位)</th><th>Act (操)</th></tr></thead>
                        <tbody id="adm-stock-list"></tbody>
                    </table>
                </div>
            </div>

            <div id="adm-area-logs" class="panel-box" style="display:none;">
                <div class="admin-sticky-header">
                    <div class="filter-bar" style="padding:0; border:none; background:transparent;">
                        <select id="adm-log-type" onchange="app.admRenderLogs()"><option value="ALL">All (全)</option><option value="IN">In (入)</option><option value="OUT">Out (出)</option></select>
                        <input id="adm-log-search" placeholder="Search (搜)..." oninput="app.admRenderLogs()" autocomplete="off">
                        <input type="date" id="adm-log-start" onchange="app.admRenderLogs()">
                        <input type="date" id="adm-log-end" onchange="app.admRenderLogs()">
                    </div>
                </div>
                <div class="admin-scroll-content">
                    <table class="report-table" style="width:100%">
                        <thead><tr><th>Time (时)</th><th>Type (类)</th><th>Name (名)</th><th>Qty (数)</th><th>Loc/Dept (位/部)</th><th>Note (源/途)</th><th>Sig (签)</th><th>Act (操)</th></tr></thead>
                        <tbody id="adm-logs-list"></tbody>
                    </table>
                </div>
            </div>

            <div id="adm-area-data" class="panel-box" style="display:none;">
                <div class="admin-scroll-content">
                    <div class="data-grid-container">
                        <div class="data-section">
                            <h4>Locations (库位)</h4>
                            <div class="ds-input-row">
                                <input id="new-loc-val" class="input" placeholder="New Loc (新库位)..." autocomplete="off">
                                <button class="btn btn-success" style="width:auto; padding:4px 10px;" onclick="app.admAddLoc()"><i class="fas fa-plus"></i></button>
                            </div>
                            <div class="ds-table-wrap">
                                <table class="report-table">
                                    <tbody id="adm-loc-list"></tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="data-section">
                            <h4>Units (单位)</h4>
                            <div class="ds-input-row">
                                <input id="new-unit-val" class="input" placeholder="New Unit (新单位)..." autocomplete="off">
                                <button class="btn btn-success" style="width:auto; padding:4px 10px;" onclick="app.admAddUnit()"><i class="fas fa-plus"></i></button>
                            </div>
                            <div class="ds-table-wrap">
                                <table class="report-table">
                                    <tbody id="adm-unit-list"></tbody>
                                </table>
                            </div>
                        </div>

                        <div class="data-section">
                            <h4>Departments (部门)</h4>
                            <div class="ds-input-row">
                                <div class="input-wrapper">
                                    <input id="new-dept" class="input" placeholder="New Dept (新部门)..." autocomplete="off">
                                    <button class="trans-btn" onclick="app.translateInput('new-dept')"><i class="fas fa-language"></i></button>
                                </div>
                                <button class="btn btn-success" style="width:auto; padding:4px 10px;" onclick="app.admAddDept()"><i class="fas fa-plus"></i></button>
                            </div>
                            <div class="ds-table-wrap">
                                <table class="report-table">
                                    <tbody id="adm-dept-list"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="adm-area-sys" class="panel-box" style="display:none;">
                <div class="admin-scroll-content">
                    <div style="margin-bottom:20px; background:#21262d; padding:15px; border-radius:6px;">
                        <div style="font-weight:700; margin-bottom:10px; color:#58a6ff">Force Sync (强制同步)</div>
                        <p style="font-size:11px; color:#8b949e; margin-bottom:10px;">Use this ONLY if Cloud data is wrong or outdated. (仅当云端数据错误时使用)</p>
                        <button class="btn btn-primary" onclick="app.forcePushToCloud()">Force Push Local to Cloud (强制上传本地数据)</button>
                    </div>

                    <div style="margin-bottom:20px; background:#21262d; padding:15px; border-radius:6px;">
                        <div style="font-weight:700; margin-bottom:10px;">Data Backup (数据备份)</div>
                        <button class="btn btn-in" onclick="app.backupData()">Backup (备份)</button>
                        <input type="file" id="file-restore" hidden onchange="app.restoreData(this)">
                        <button class="btn btn-out" style="margin-top:10px" onclick="document.getElementById('file-restore').click()">Restore (恢复)</button>
                    </div>
                    
                    <div style="margin-bottom:20px; background:#21262d; padding:15px; border-radius:6px; border:1px solid var(--border);">
                        <label class="label">Reset Keeper Password (重置库管员密码)</label>
                        <div style="display:flex; gap:10px;">
                            <input id="new-pass-keeper" class="input" placeholder="New Keeper Password" autocomplete="off">
                            <button class="btn btn-primary" style="width:auto" onclick="app.changePassword('keeper')">Update (更新)</button>
                        </div>
                    </div>

                    <div style="margin-bottom:20px;">
                        <div style="font-weight:700; color:var(--primary); margin-bottom:15px; border-bottom:1px solid #30363d; padding-bottom:5px;">Security (安全)</div>
                        <div style="margin-bottom:15px; background:#21262d; padding:15px; border-radius:6px; border:1px solid var(--border);">
                            <label class="label">Change Admin Password (修改管理员密码)</label>
                            <div style="display:flex; gap:10px;">
                                <input id="new-pass-admin" class="input" placeholder="New Password" autocomplete="off">
                                <button class="btn btn-primary" style="width:auto" onclick="app.changePassword('admin')">Update (更新)</button>
                            </div>
                        </div>
                        <div style="margin-bottom:15px; background:#21262d; padding:15px; border-radius:6px; border:1px solid var(--border);">
                            <label class="label">Change God Password (修改上帝密码)</label>
                            <div style="display:flex; gap:10px;">
                                <input id="new-pass-god" class="input" placeholder="New God Password" autocomplete="off">
                                <button class="btn btn-danger" style="width:auto" onclick="app.changePassword('god')">Update (更新)</button>
                            </div>
                        </div>
                    </div>
                    <div>
                        <div style="font-weight:700; color:#ef4444; margin-bottom:10px; border-bottom:1px solid #30363d; padding-bottom:5px;">Danger Zone (危险区)</div>
                        <button class="btn btn-danger" onclick="app.resetData()">⚠️ Reset All Data (清空所有数据)</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="modal-sign">
        <div class="modal-box big-sign">
            <button class="modal-close-btn" onclick="app.closeSign()"><i class="fas fa-times"></i></button>
            <h3 style="text-align:center;color:var(--text)">Sign Below (请在下方签字)</h3>
            <canvas id="sig-canvas" class="sig-canvas"></canvas>
            <div style="display:flex;gap:15px;margin-top:10px;">
                <button class="btn" style="flex:1;background:#21262d;color:var(--text)" onclick="app.closeSign()">Cancel (取消)</button>
                <button class="btn" style="flex:1;background:#21262d;color:var(--text)" onclick="app.clearSig()">Clear (清除)</button>
                <button class="btn btn-primary" style="flex:2" onclick="app.saveSig()">Confirm (确认)</button>
            </div>
        </div>
    </div>
    
    <div id="toast-msg"><i class="fas fa-check-circle"></i> Sync Success!</div>
    <datalist id="dl-handlers"></datalist><datalist id="dl-receivers"></datalist>
    <div id="print-area"></div>
    
    <script>
        /* * KMC Logistics - Main Logic */
        const supabaseUrl = 'https://jqxdiomkyeojofclpvyq.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpxeGRpb21reWVvam9mY2xwdnlxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5MDI5ODAsImV4cCI6MjA4NTQ3ODk4MH0.plc9LeoaOLGowdVIiUUaHMASQf9e0EhaIH7HJvxevF0';
        const _client = supabase.createClient(supabaseUrl, supabaseKey);

        const app = {
            data: { 
                list: [], 
                history: [], 
                settings: { 
                    adminPass:'admin123', 
                    godPass:'sqx1987923', 
                    keeperPass:'666666', 
                    depts: ["Finance", "Admin", "Safety", "Quality", "Logistics", "Business", "Mining", "Mech", "Plant"], 
                    locations: ["W1", "W2", "Club"], 
                    units: ["Pcs (个)", "Set (套)", "Box (箱)", "Pack (包)", "Unit (台)", "Item (件)", "Pair (双)", "Barrel (桶)"], 
                    constraints: { in_handler:true, in_source:true, out_dept:true, out_receiver:true, out_usage:true } 
                } 
            },
            temp: { cart: { in: [], out: [] }, signType: null, sig: null, curTab: 'in', admTab: 'stock', adminClicks: 0, adminTimer: null, debounceTimer: null },
            currentUser: { role: null, token: null },
            dictionary: { "Lite Beer": "Lite啤酒", "Lite啤酒": "Lite Beer", "Fans": "电风扇", "电风扇": "Fans" },

            showToast: function(msg, type = 'success') {
                const t = document.getElementById('toast-msg');
                t.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> ${msg}`;
                t.style.background = type === 'success' ? '#238636' : '#da3633';
                t.classList.add('show');
                setTimeout(() => t.classList.remove('show'), 3000);
            },

            translateInput: function(id) {
                clearTimeout(this.temp.debounceTimer);
                const el = document.getElementById(id);
                const val = el.value.trim();
                if (!val) return;
                this.temp.debounceTimer = setTimeout(async () => {
                    this._performTranslate(id, val);
                }, 600);
            },

            _performTranslate: async function(id, val) {
                const el = document.getElementById(id);
                if (val.includes('(') && val.includes(')')) return; 

                const btn = el.nextElementSibling; 
                const icon = btn ? btn.querySelector('i') : null;
                if(icon) icon.className = "fas fa-spinner fa-spin"; 

                try {
                    const isChinese = /[\u4e00-\u9fa5]/.test(val);
                    const langPair = isChinese ? "zh-CN|en" : "en|zh-CN";
                    const response = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(val)}&langpair=${langPair}`);
                    const data = await response.json();
                    if(data.responseData && data.responseData.translatedText) {
                        const translation = data.responseData.translatedText;
                        el.value = `${val} (${translation})`;
                        if (id.startsWith('in')) this.fillItemInfo('in', el.value);
                        if (id.startsWith('out')) this.checkStock(el.value);
                    }
                } catch (e) {
                    console.warn("Translation Limit, using dictionary");
                    let trans = this.dictionary[val] || ( /[\u4e00-\u9fa5]/.test(val) ? "Trans_EN" : "Trans_CN" );
                    el.value = `${val} (${trans})`;
                } finally {
                    if(icon) icon.className = "fas fa-language";
                }
            },

            showSuggestions: function(inputEl, type) {
                const val = inputEl.value.toLowerCase();
                const listId = type === 'in' ? 'in-name-suggestions' : 'out-name-suggestions';
                const listEl = document.getElementById(listId);
                if (!val) { listEl.style.display = 'none'; return; }
                const matches = this.data.list.filter(item => item.name.toLowerCase().includes(val));
                if (matches.length === 0) { listEl.style.display = 'none'; return; }
                listEl.innerHTML = matches.map(item => `
                    <div class="suggestion-item" onmousedown="app.selectSuggestion('${type}', '${item.name.replace(/'/g, "\\'")}')">
                        ${item.name} <strong style="float:right">${item.qty} ${item.unit}</strong>
                    </div>
                `).join('');
                listEl.style.display = 'block';
            },

            selectSuggestion: function(type, name) {
                const inputId = type === 'in' ? 'in-name' : 'out-name';
                document.getElementById(inputId).value = name;
                document.getElementById(type === 'in' ? 'in-name-suggestions' : 'out-name-suggestions').style.display = 'none';
                if (type === 'in') this.fillItemInfo('in', name);
                if (type === 'out') this.checkStock(name);
            },

            getLastModified: function(dataObj) {
                if (!dataObj || !dataObj.history || dataObj.history.length === 0) return 0;
                return dataObj.history[0].ts || 0;
            },

            init: async function() {
                const d = new Date().toISOString().split('T')[0];
                ['rep-start', 'rep-end', 'adm-log-start', 'adm-log-end'].forEach(id => {
                    const el = document.getElementById(id);
                    if(el) el.value = d;
                });
                
                let localData = null;
                const localStr = localStorage.getItem('kmc_v67');
                if(localStr) {
                    try { 
                        localData = JSON.parse(localStr);
                        this.data = localData; 
                        this.refreshDatalists();
                    } catch(e) { console.error("Local corrupt"); }
                }

                await this.smartSync(localData);
                
                this.checkSettings();
                this.refreshDatalists();
                this.applyRules(); 

                window.addEventListener('storage', (e) => { 
                    if (e.key === 'kmc_v67') { 
                        this.data = JSON.parse(e.newValue); 
                        this.refreshDatalists(); 
                    } 
                });
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.input-wrapper')) document.querySelectorAll('.suggestion-list').forEach(el => el.style.display = 'none');
                });
            },

            smartSync: async function(currentLocalData) {
                const btn = document.getElementById('cloud-btn');
                if(btn) btn.className = "icon-btn sync spinning"; 
                
                const local = currentLocalData || this.data;
                try {
                    let { data: cloudRow, error } = await _client.from('kmc_core').select('content').eq('id', 1).maybeSingle();
                    if (error && error.code !== 'PGRST116') throw error;
                    
                    let cloud = (cloudRow && cloudRow.content) ? cloudRow.content : null;
                    if (!cloud) {
                        await this.pushToCloud(true);
                    } else if (!local || !local.history || local.history.length === 0) {
                        this.data = cloud;
                        this.saveToLocal();
                        this.showToast("Data pulled from Cloud", "success");
                    } else {
                        const localTS = this.getLastModified(local);
                        const cloudTS = this.getLastModified(cloud);
                        
                        if (localTS > cloudTS) {
                            this.data = local;
                            await this.pushToCloud(true);
                            this.showToast("Local changes uploaded");
                        } else if (cloudTS > localTS) {
                            const dateStr = new Date(cloudTS).toLocaleString();
                            if(confirm(`⚠️ Cloud data is newer (${dateStr}).\nUpdate local data from Cloud?\n(Cancel to keep local data only)`)) {
                                this.data = cloud;
                                this.saveToLocal();
                                this.showToast("Updated from Cloud");
                            } else {
                                this.showToast("Sync Cancelled (Local Kept)", "error");
                            }
                        }
                    }
                    
                    if(btn) btn.className = "icon-btn sync success";
                    setTimeout(() => { if(btn) btn.className = "icon-btn sync"; }, 1000);
                    if(document.getElementById('modal-report-center').style.display === 'flex') {
                        this.renderReport();
                    }
                    this.refreshDatalists();
                } catch(e) {
                    console.error("Smart Sync Error:", e);
                    if(btn) btn.className = "icon-btn exit"; 
                    this.showToast("Sync Error: Check Console", "error");
                }
            },
            
            checkSettings: function() {
                if(!this.data.settings) this.data.settings = {};
                if(!this.data.settings.constraints) {
                    this.data.settings.constraints = { in_handler:true, in_source:true, out_dept:true, out_receiver:true, out_usage:true };
                }
                if(!this.data.settings.godPass) this.data.settings.godPass = 'sqx1987923';
                if(!this.data.settings.adminPass) this.data.settings.adminPass = 'admin123';
                if(!this.data.settings.keeperPass) this.data.settings.keeperPass = '666666'; 
            },
            
            saveToLocal: function() { 
                try { localStorage.setItem('kmc_v67', JSON.stringify(this.data));
                } catch(e) { alert("Storage Full!"); }
            },

            pushToCloud: async function(silent = false) { 
                this.saveToLocal();
                const btn = document.getElementById('cloud-btn');
                if(!silent && btn) btn.className = "icon-btn sync spinning";
                try {
                    const { error } = await _client.from('kmc_core').upsert({ id: 1, content: this.data });
                    if(error) throw error;
                    
                    if(!silent && btn) btn.className = "icon-btn sync success";
                    if(!silent && btn) setTimeout(() => btn.className = "icon-btn sync", 1000); 
                    
                    if(!silent) this.showToast("Saved to Cloud!");
                } catch(e) {
                    console.error(e);
                    if(!silent && btn) btn.className = "icon-btn exit";
                    if(!silent) this.showToast("Network Error - Saved Locally", "error");
                }
            },

            forcePushToCloud: async function() {
                if(confirm("DANGER: This will overwrite Cloud data with THIS device's data. Continue?")) {
                    await this.pushToCloud(false);
                }
            },

            exportPDF: function() { 
                const el = document.getElementById('print-area');
                let title = "";
                if (this.temp.curTab === 'in') title = "Inbound Report (入库报表)";
                else if (this.temp.curTab === 'out') title = "Outbound Report (出库报表)";
                else title = "Stock Report (即时库存报表)";

                let tableHTML = document.getElementById('rep-table').outerHTML;
                el.innerHTML = `<h2 style="text-align:center;">${title}</h2><div class="meta">Export Date (导出时间): ${new Date().toLocaleString()}</div>${tableHTML}`;
                
                this.showToast("Generating PDF...");
                setTimeout(() => {
                    html2canvas(el, {scale: 2, useCORS: true, backgroundColor: '#ffffff', scrollY: 0}).then(c => {
                        const p = new window.jspdf.jsPDF('p', 'mm', 'a4');
                        p.addImage(c.toDataURL('image/jpeg', 0.9), 'JPEG', 10, 10, 190, (c.height * 190) / c.width); 
                        p.save('KMC_Report.pdf'); el.innerHTML = '';
                        this.showToast("PDF Downloaded");
                    }); 
                }, 200);
            },

            triggerAdmin: function() {
                clearTimeout(this.temp.adminTimer);
                this.temp.adminClicks++;
                if(this.temp.adminClicks === 7) {
                    this.temp.adminClicks = 0;
                    if(prompt("Admin Password (God Mode):") === this.data.settings.godPass) this.openAdminUltimate();
                    else this.showToast("Access Denied", "error");
                }
                this.temp.adminTimer = setTimeout(() => this.temp.adminClicks = 0, 2000);
            },
            openAdminUltimate: function() {
                document.getElementById('modal-admin-ultimate').style.display='flex';
                this.switchAdminTab('stock');
                const c = this.data.settings.constraints;
                for(let k in c) if(document.getElementById('sw-'+k)) document.getElementById('sw-'+k).checked = c[k];
            },
            
            switchAdminTab: function(t) {
                document.querySelectorAll('.god-card').forEach(e=>e.classList.remove('active'));
                document.getElementById('at-'+t).classList.add('active');
                ['stock', 'logs', 'sys', 'data'].forEach(k => document.getElementById('adm-area-'+k).style.display = 'none');
                document.getElementById('adm-area-'+t).style.display = 'block';
                if(t==='stock') this.admRenderStock();
                if(t==='logs') this.admRenderLogs();
                if(t==='data') { this.admRenderLocs(); this.admRenderUnits(); this.admRenderDepts(); }
            },
            
            admRenderStock: function() {
                const name = document.getElementById('filter-stock-name').value.toLowerCase();
                const loc = document.getElementById('filter-stock-loc').value.toLowerCase();
                const filtered = this.data.list.filter(i => i.name.toLowerCase().includes(name) && i.loc.toLowerCase().includes(loc));
                document.getElementById('adm-stock-list').innerHTML = filtered.map((item, idx) => {
                    const realIdx = this.data.list.indexOf(item);
                    return `<tr style="border-bottom:1px solid #30363d">
                        <td><input class="adm-input" value="${item.name}" onchange="app.admUpdStock(${realIdx},'name',this.value)" style="text-align:left"></td>
                        <td><input class="adm-input" type="number" value="${item.qty}" onchange="app.admUpdStock(${realIdx},'qty',this.value)"></td>
                        <td><input class="adm-input" value="${item.unit}" onchange="app.admUpdStock(${realIdx},'unit',this.value)"></td>
                        <td><input class="adm-input" value="${item.loc}" onchange="app.admUpdStock(${realIdx},'loc',this.value)"></td>
                        <td style="text-align:center"><i class="fas fa-trash" style="color:#da3633;cursor:pointer" onclick="app.admDelStock(${realIdx})"></i></td>
                    </tr>`}).join('');
            },
            admUpdStock: function(i, f, v) { if(f==='qty') v=parseInt(v); this.data.list[i][f]=v;
            this.pushToCloud(); }, 
            admDelStock: function(i) { if(confirm("Delete?")) { this.data.list.splice(i,1);
            this.pushToCloud(); this.admRenderStock(); } },
            admAddStock: function() {
                const n=document.getElementById('new-name').value, q=parseInt(document.getElementById('new-qty').value), u=document.getElementById('new-unit').value, l=document.getElementById('new-loc').value;
                if(n && !isNaN(q)) {
                    if(this.data.list.some(x => x.name === n)) return alert("Item Exists!");
                    this.data.list.unshift({name:n, qty:q, unit:u, loc:l}); 
                    this.pushToCloud(); this.admRenderStock(); 
                    document.getElementById('new-name').value=''; 
                }
            },

            restoreData: function(el) {
                const f = el.files[0];
                if(f) {
                    const r = new FileReader();
                    r.onload = async (e) => { 
                        try {
                            const parsed = JSON.parse(e.target.result);
                            if(confirm("Restore data from file? Current data will be replaced.")) {
                                this.data = parsed;
                                this.checkSettings(); 
                                this.saveToLocal();
                                await this.pushToCloud(); 
                                alert("Data Restored Successfully!");
                                location.reload();
                            }
                        } catch(x) { alert("Invalid File Format"); }
                    };
                    r.readAsText(f);
                }
            },
            
            backupData: function() {
                const blob = new Blob([JSON.stringify(this.data)], {type: "application/json"});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href=url; a.download=`KMC_Backup_${Date.now()}.json`; a.click();
            },
            
            adminManualSave: function() {
                this.pushToCloud();
            },

            renderManager: function(type, dataArr) {
                const tableId = `adm-${type}-list`;
                document.getElementById(tableId).innerHTML = dataArr.map((val, i) => `
                    <tr>
                        <td>${val}</td>
                        <td style="width:30px; text-align:center"><i class="fas fa-times del-btn" onclick="app.admDelItem('${type}', ${i})"></i></td>
                    </tr>
                `).join('');
            },

            admRenderLocs: function() { this.renderManager('loc', this.data.settings.locations);
            },
            admRenderUnits: function() { this.renderManager('unit', this.data.settings.units);
            },
            admRenderDepts: function() { this.renderManager('dept', this.data.settings.depts);
            },
            
            admAddItem: function(type) {
                const inputId = type === 'dept' ? 'new-dept' : `new-${type}-val`;
                const el = document.getElementById(inputId);
                const val = el.value.trim();
                if(val) {
                    const arr = type==='loc' ? this.data.settings.locations : type==='unit' ? this.data.settings.units : this.data.settings.depts;
                    arr.push(val); 
                    this.pushToCloud(); 
                    if(type==='loc') this.admRenderLocs(); 
                    if(type==='unit') this.admRenderUnits(); 
                    if(type==='dept') this.admRenderDepts();
                    this.refreshDatalists();
                    el.value='';
                }
            },
            admAddLoc: function() { this.admAddItem('loc');
            },
            admAddUnit: function() { this.admAddItem('unit');
            },
            admAddDept: function() { this.admAddItem('dept');
            },
            
            admDelItem: function(type, i) {
                if(confirm("Delete?")) {
                    const arr = type==='loc' ? this.data.settings.locations : type==='unit' ? this.data.settings.units : this.data.settings.depts;
                    arr.splice(i,1); 
                    this.pushToCloud(); 
                    if(type==='loc') this.admRenderLocs(); 
                    if(type==='unit') this.admRenderUnits(); 
                    if(type==='dept') this.admRenderDepts();
                    this.refreshDatalists();
                }
            },

            // [核心功能验证] Admin Logs 渲染逻辑 - 包含新增的 Note 列
            admRenderLogs: function() {
                const type = document.getElementById('adm-log-type').value;
                const search = document.getElementById('adm-log-search').value.toLowerCase();
                const filtered = this.data.history.filter(h => {
                    const matchType = (type === 'ALL') || (h.type === type);
                    const matchText = (h.name||'').toLowerCase().includes(search);
                    return matchType && matchText;
                });
                document.getElementById('adm-logs-list').innerHTML = filtered.map((h, i) => `
                    <tr>
                        <td><input type="date" value="${new Date(h.ts).toISOString().split('T')[0]}" onchange="app.admUpdLog(${this.data.history.indexOf(h)}, 'ts', this.value)" style="width:90px; background:transparent; border:none; color:white; font-size:10px;"></td>
                        <td>${h.type}</td>
                        <td><input class="adm-input" value="${h.name}" onchange="app.admUpdLog(${this.data.history.indexOf(h)},'name',this.value)"></td>
                        <td><input class="adm-input" type="number" value="${h.qty}" onchange="app.admUpdLog(${this.data.history.indexOf(h)},'qty',this.value)" style="width:40px"></td>
                        <td><input class="adm-input" value="${h.loc||h.dept||''}" onchange="app.admUpdLog(${this.data.history.indexOf(h)}, h.type==='IN'?'loc':'dept', this.value)"></td>
                        
                        <td><input class="adm-input" value="${h.remark||''}" onchange="app.admUpdLog(${this.data.history.indexOf(h)}, 'remark', this.value)"></td>
                        
                        <td>${h.proof?`<img src="${h.proof}" class="sig-thumb">`:'-'}</td>
                        <td style="text-align:center"><i class="fas fa-trash" style="color:#da3633;cursor:pointer" onclick="app.admDelLog(${this.data.history.indexOf(h)})"></i></td>
                    </tr>
                `).join('');
            },
            
            admUpdLog: function(i, f, v) { 
                const log = this.data.history[i];
                if(f === 'qty') {
                    const oldQty = log.qty;
                    const newQty = parseInt(v); 
                    const diff = newQty - oldQty; 
                    const item = this.data.list.find(x => x.name === log.name);
                    if(item) {
                        if(log.type === 'IN') item.qty += diff;
                        else item.qty -= diff;
                    }
                    this.data.history[i][f] = parseInt(v);
                } else if (f === 'ts') {
                    this.data.history[i][f] = new Date(v).getTime();
                } else {
                    this.data.history[i][f] = v;
                }
                this.pushToCloud();
            },

            admDelLog: function(i) {
                if(confirm("Delete Log? Stock will revert.")) { 
                    const log = this.data.history[i];
                    const item = this.data.list.find(x => x.name === log.name);
                    
                    if(item) {
                        if(log.type === 'IN') item.qty -= log.qty;
                        else item.qty += log.qty;
                        if(item.qty < 0) item.qty = 0;
                    } else {
                        alert("⚠️ Warning: Original item not found. Log deleted but stock NOT reverted.");
                    }

                    this.data.history.splice(i, 1);
                    this.pushToCloud(); 
                    this.admRenderLogs(); 
                }
            },

            toggleRule: function(key, checked) { this.data.settings.constraints[key] = checked;
            this.pushToCloud(); this.applyRules(); },
            applyRules: function() { const c = this.data.settings.constraints;
            for(let k in c) { const s=document.querySelector(`.req-${k}`); if(s) s.style.display = c[k]?'inline':'none';
            } },

            roleSwitch: function(val) { document.getElementById('pass-area').style.display = 'block';
            }, 

            login: function() {
                const r = document.getElementById('login-role').value;
                const p = document.getElementById('login-pass').value;
                let targetPass = '';

                if (r === 'admin') targetPass = this.data.settings.adminPass;
                else targetPass = this.data.settings.keeperPass;
                if (p !== targetPass) return this.showToast('Wrong Password', 'error');

                if (r === 'admin') {
                    document.getElementById('card-rules').style.display='block';
                } else {
                    document.getElementById('card-rules').style.display='none';
                }
                
                this.currentUser.role = r;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('user-badge').innerText = r === 'keeper' ? 'KEEPER' : 'ADMIN';
                this.refreshDatalists();
                setTimeout(() => {
                    this.openReportCenter();
                    this.switchTab('stock');
                }, 300);
            },
            
            changePassword: function(role) {
                let id = 'new-pass-' + role;
                let val = document.getElementById(id).value;
                if(!val) return alert("Empty Password");
                if(role === 'keeper') this.data.settings.keeperPass = val;
                if(role === 'admin') this.data.settings.adminPass = val;
                if(role === 'god') this.data.settings.godPass = val;
                this.pushToCloud();
                this.showToast("Password Updated!");
                document.getElementById(id).value = '';
            },

            addToCart: function(type) {
                const name = document.getElementById(type+'-name').value;
                const qty = parseInt(document.getElementById(type+'-qty').value); 
                const unit = document.getElementById(type+'-unit').value;
                if(!name || !qty || qty <= 0) return this.showToast("Fill Name & Qty", "error");
                if(type === 'in') {
                    const loc = document.getElementById('in-loc').value;
                    if(!loc) return this.showToast("Loc required", "error");
                    this.temp.cart.in.push({ name, qty, unit, loc });
                    document.getElementById('in-name').value='';document.getElementById('in-qty').value='';
                } else {
                    const item = this.data.list.find(i=>i.name===name);
                    if(!item) return this.showToast("Item not found", "error");
                    const alreadyInCart = this.temp.cart.out.filter(c => c.name === name).reduce((sum, c) => sum + c.qty, 0);
                    if(item.qty < (qty + alreadyInCart)) return this.showToast("Insufficient Stock", "error");
                    this.temp.cart.out.push({ name, qty, unit: item.unit });
                    document.getElementById('out-name').value='';document.getElementById('out-qty').value='';
                }
                this.renderCart(type);
            },
            renderCart: function(type) {
                const list = this.temp.cart[type];
                document.getElementById(type+'-cart-list').innerHTML = list.map((item, idx) => `<tr><td>${item.name}</td><td>${item.qty} ${item.unit||''}</td>${type==='in'?`<td>${item.loc}</td>`:''}<td><i class="fas fa-times del-btn" onclick="app.delFromCart('${type}', ${idx})"></i></td></tr>`).join('');
                document.getElementById(type+'-cart-empty').style.display = list.length?'none':'block';
                if(this.temp.sig && this.temp.signType === type) document.getElementById('btn-'+type+'-submit').disabled = !list.length;
            },
            delFromCart: function(type, idx) { this.temp.cart[type].splice(idx, 1);
            this.renderCart(type); },
            
            submitBatch: function(type) {
                const list = this.temp.cart[type];
                if(!list.length || !this.temp.sig) return alert("Cart empty or No Sign");
                const batchId = Date.now().toString();
                if(type === 'in') {
                    const h = document.getElementById('in-handler').value, s = document.getElementById('in-source').value;
                    if(this.data.settings.constraints.in_handler && !h) return this.showToast("Handler required", "error");
                    list.forEach(i => {
                        let stock = this.data.list.find(x=>x.name===i.name);
                        if(stock) { stock.qty += i.qty; if(stock.loc!==i.loc && !stock.loc.includes(i.loc)) stock.loc+=", "+i.loc; } 
                        else { this.data.list.push(i); }
                        this.data.history.unshift({ts:Date.now(), bid:batchId, type:'IN', name:i.name, qty:i.qty, unit:i.unit, loc:i.loc, handler:h, remark:s, proof:this.temp.sig});
                    });
                } else {
                    const d = document.getElementById('out-dept').value, r = document.getElementById('out-receiver').value, u = document.getElementById('out-usage').value;
                    if(this.data.settings.constraints.out_dept && !d) return this.showToast("Dept required", "error");
                    list.forEach(i => {
                        let stock = this.data.list.find(x=>x.name===i.name);
                        if(stock) stock.qty-=i.qty;
                        this.data.history.unshift({ts:Date.now(), bid:batchId, type:'OUT', name:i.name, qty:i.qty, dept:d, receiver:r, remark:u, proof:this.temp.sig});
                    });
                }
                this.pushToCloud(); 
                this.temp.cart[type]=[]; this.temp.sig=null; 
                document.getElementById(type+'-prev').classList.remove('show');
                document.getElementById('btn-'+type+'-submit').disabled=true;
                this.renderCart(type); this.refreshDatalists();
                this.showToast("Batch Submitted!", "success");
            },

            openReportCenter: function() { 
                const modal = document.getElementById('modal-report-center');
                if(modal) {
                    modal.style.display = 'flex';
                    this.renderReport();
                }
            },
            closeReportCenter: function() { document.getElementById('modal-report-center').style.display = 'none';
            },
            switchTab: function(t) { this.temp.curTab = t; document.querySelectorAll('#modal-report-center .fm-tab').forEach(e=>e.classList.remove('active'));
            document.getElementById('tab-'+t).classList.add('active'); this.renderReport(); },
            
            renderReport: function() {
                try {
                    const t = this.temp.curTab;
                    if(t==='stock') {
                        const filtered = this.data.list.filter(i => i.name.toLowerCase().includes(document.getElementById('rep-search').value.toLowerCase()));
                        document.getElementById('rep-table').innerHTML = `<thead><tr><th>Name (名)</th><th>Qty (数)</th><th>Unit (单)</th><th>Loc (位)</th></tr></thead><tbody>${filtered.map(i=>`<tr><td>${i.name}</td><td>${i.qty}</td><td>${i.unit}</td><td>${i.loc}</td></tr>`).join('')}</tbody>`;
                    } else {
                        const rawData = this.data.history.filter(x => (t==='in'?x.type==='IN':x.type==='OUT'));
                        const groups = {}; rawData.forEach(item => { const gid = item.bid || item.ts; if(!groups[gid]) groups[gid]={meta:item, items:[]}; groups[gid].items.push(item); });
                        const rows = Object.values(groups).map(g => {
                            const items = g.items.map(i=>`<div class="batch-item-row"><span class="batch-name">${i.name}</span><span class="batch-qty">${i.qty} ${i.unit||''}</span></div>`).join('');
                            return `<tr>
                                <td>${new Date(g.meta.ts).toLocaleDateString()}</td>
                                <td style="padding:0 8px">${items}</td>
                                <td>${g.meta.loc||g.meta.dept}</td>
                                <td>${g.meta.handler||g.meta.receiver}</td>
                                <td>${g.meta.remark||'-'}</td>
                                <td>${g.meta.proof?`<img src="${g.meta.proof}" class="sig-thumb">`:''}</td>
                            </tr>`;
                        }).join('');
                        document.getElementById('rep-table').innerHTML = `<thead><tr><th>Date (日)</th><th>Items (明细)</th><th>${t==='in'?'Loc (位)':'Dept (部)'}</th><th>User (人)</th><th>${t==='in'?'Source (源)':'Usage (途)'}</th><th>Sig (签)</th></tr></thead><tbody>${rows}</tbody>`;
                    }
                } catch(e) {
                    console.error("Report render error", e);
                }
            },
            
            togglePanel: function(t) { document.querySelectorAll('.panel-box').forEach(b => b.style.display='none');
            document.querySelectorAll('.action-card').forEach(c => c.classList.remove('active')); document.getElementById('panel-'+t).style.display='block'; document.getElementById('card-'+t).classList.add('active'); },
            
            _getCanvasPos: function(canvas, evt) {
                const rect = canvas.getBoundingClientRect();
                const clientX = evt.touches ? evt.touches[0].clientX : evt.clientX;
                const clientY = evt.touches ? evt.touches[0].clientY : evt.clientY;
                return {
                    x: clientX - rect.left,
                    y: clientY - rect.top
                };
            },

            openSign: function(type) { 
                this.temp.signType = type;
                const modal = document.getElementById('modal-sign');
                modal.style.display = 'flex'; 
                
                requestAnimationFrame(() => {
                    const canvas = document.getElementById('sig-canvas');
                    canvas.width = canvas.clientWidth;
                    canvas.height = canvas.clientHeight;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.lineWidth = 3;
                    ctx.strokeStyle = "#000";
                    ctx.lineCap = "round";

                    let isDrawing = false;

                    const startDraw = (e) => {
                        isDrawing = true;
                        ctx.beginPath();
                        const pos = this._getCanvasPos(canvas, e);
                        ctx.moveTo(pos.x, pos.y);
                        e.preventDefault();
                    };

                    const drawing = (e) => {
                        if (!isDrawing) return;
                        const pos = this._getCanvasPos(canvas, e);
                        ctx.lineTo(pos.x, pos.y);
                        ctx.stroke();
                        e.preventDefault();
                    };

                    const stopDraw = () => { isDrawing = false; };

                    canvas.ontouchstart = startDraw;
                    canvas.onmousedown = startDraw;
                    canvas.ontouchmove = drawing;
                    canvas.onmousemove = drawing;
                    canvas.ontouchend = stopDraw;
                    canvas.onmouseup = stopDraw;
                });
            },

            closeSign: function() { document.getElementById('modal-sign').style.display='none';
            },
            
            saveSig: function() { 
                const c=document.getElementById('sig-canvas');
                const t=document.createElement('canvas');
                t.width=300; t.height=150;
                const x=t.getContext('2d');
                x.fillStyle = "#ffffff";
                x.fillRect(0,0,300,150);
                x.drawImage(c,0,0,300,150);
                this.temp.sig=t.toDataURL('image/jpeg',0.3); 
                document.getElementById(this.temp.signType+'-prev').src=this.temp.sig; 
                document.getElementById(this.temp.signType+'-prev').classList.add('show'); 
                document.getElementById('modal-sign').style.display='none'; 
                this.renderCart(this.temp.signType);
            },
            
            clearSig: function() { 
                const c=document.getElementById('sig-canvas');
                const x=c.getContext('2d');
                x.fillStyle = '#ffffff';
                x.fillRect(0,0,c.width,c.height);
            },
            
            fillItemInfo: function(t, v) { 
                if(t==='in'){
                    let item = this.data.list.find(x => x.name === v);
                    if(item){
                        const unitSel = document.getElementById('in-unit');
                        for(let i=0;i<unitSel.options.length;i++) if(unitSel.options[i].value===item.unit) unitSel.selectedIndex=i;
                        const locSel = document.getElementById('in-loc');
                        for(let i=0;i<locSel.options.length;i++) if(locSel.options[i].value===item.loc) locSel.selectedIndex=i;
                        document.getElementById('in-stock-hint').style.display = 'block';
                        document.getElementById('in-stock-hint').innerHTML = `Stock: ${item.qty} | Unit: ${item.unit}`;
                    }
                } 
            },
            
            checkStock: function(v) { 
                const i=this.data.list.find(x=>x.name===v);
                if(i){
                    document.getElementById('stock-hint').style.display='block';
                    document.getElementById('stock-hint').innerHTML = `Stock: ${i.qty}`;
                    const unitSel = document.getElementById('out-unit');
                    document.getElementById('out-unit').value = i.unit;
                    document.getElementById('out-qty').max = i.qty;
                }
            },
            
            refreshDatalists: function() { 
                const d = this.data.settings.depts || [];
                const l = this.data.settings.locations || [];
                const u = this.data.settings.units || [];
                const makeOpts = (arr) => `<option value="">Select...</option>` + arr.map(x=>`<option value="${x}">${x}</option>`).join('');
                
                if(document.getElementById('in-loc')) document.getElementById('in-loc').innerHTML = makeOpts(l);
                if(document.getElementById('new-loc')) document.getElementById('new-loc').innerHTML = makeOpts(l);
                if(document.getElementById('in-unit')) document.getElementById('in-unit').innerHTML = makeOpts(u);
                if(document.getElementById('new-unit')) document.getElementById('new-unit').innerHTML = makeOpts(u);
                if(document.getElementById('out-dept')) document.getElementById('out-dept').innerHTML = makeOpts(d);
                
                document.getElementById('dl-handlers').innerHTML=[...new Set(this.data.history.filter(x=>x.type==='IN').map(x=>x.handler))].map(x=>`<option value="${x}">`).join('');
                document.getElementById('dl-receivers').innerHTML=[...new Set(this.data.history.filter(x=>x.type==='OUT').map(x=>x.receiver))].map(x=>`<option value="${x}">`).join('');
            },
            
            resetData: function() { if(confirm("RESET ALL DATA?")) { this.data.list=[];
            this.data.history=[]; this.saveToLocal(); this.pushToCloud(); location.reload(); } },
            exportExcel: function() { const wb=XLSX.utils.book_new(), ws=XLSX.utils.table_to_sheet(document.getElementById('rep-table'));
            XLSX.utils.book_append_sheet(wb,ws,"Report"); XLSX.writeFile(wb,"KMC_Report.xlsx"); }
        };
        window.onload = () => app.init();
    </script>
</body>
</html>
